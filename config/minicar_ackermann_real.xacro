<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro" name="minicar_ackermann_real">

  <!-- Launch arguments -->
  <xacro:arg name="robot_ns" default="real_robot"/>

  <!-- Minimal robot structure for hardware interface -->
  <link name="base_link"/>
  <link name="rear_left_wheel"/>
  <link name="rear_right_wheel"/>
  <link name="front_left_steering"/>
  <link name="front_right_steering"/>

  <joint name="rear_left_wheel_joint" type="continuous">
    <parent link="base_link"/>
    <child link="rear_left_wheel"/>
  </joint>
  <joint name="rear_right_wheel_joint" type="continuous">
    <parent link="base_link"/>
    <child link="rear_right_wheel"/>
  </joint>
  <joint name="front_left_steering_joint" type="revolute">
    <parent link="base_link"/>
    <child link="front_left_steering"/>
    <limit lower="-0.5236" upper="0.5236" effort="10" velocity="1.0"/>
  </joint>
  <joint name="front_right_steering_joint" type="revolute">
    <parent link="base_link"/>
    <child link="front_right_steering"/>
    <limit lower="-0.5236" upper="0.5236" effort="10" velocity="1.0"/>
  </joint>

  <!-- ros2_control hardware interface definition -->
  <ros2_control name="AckermannRealSystem" type="system">
    <hardware>
      <plugin>minicar_ackermann_hardware/AckermannHardwareInterface</plugin>

      <!-- I2C Configuration -->
      <param name="i2c_device">/dev/i2c-1</param>
      <param name="pca9685_address">64</param>  <!-- 0x40 in decimal -->

      <!-- Wheel Parameters -->
      <param name="wheel_radius">0.032</param>  <!-- TT-02 wheel radius in meters -->
      <param name="max_wheel_velocity_rad_per_sec">50.0</param>  <!-- Max wheel speed -->

      <!-- Steering Parameters -->
      <param name="max_steering_angle_rad">0.5236</param>  <!-- 30 degrees -->

      <!-- Servo Calibration (adjust based on actual servo) -->
      <param name="servo_min_pulse_ms">1.0</param>
      <param name="servo_center_pulse_ms">1.5</param>
      <param name="servo_max_pulse_ms">2.0</param>

      <!-- PCA9685 Clock Correction (per-board oscillator drift) -->
      <param name="clock_correction">1.1</param>

      <!-- ESC Calibration (adjust based on actual ESC) -->
      <param name="esc_min_pulse_ms">1.0</param>
      <param name="esc_center_pulse_ms">1.5</param>
      <param name="esc_max_pulse_ms">2.0</param>

      <!-- Open-loop Odometry (no encoders) -->
      <param name="use_open_loop_odometry">true</param>
      <param name="open_loop_velocity_scale">1.0</param>
    </hardware>

    <!-- Rear wheels: velocity command interface -->
    <joint name="rear_left_wheel_joint">
      <command_interface name="velocity">
        <param name="min">-50.0</param>
        <param name="max">50.0</param>
      </command_interface>
      <state_interface name="position"/>
      <state_interface name="velocity"/>
    </joint>

    <joint name="rear_right_wheel_joint">
      <command_interface name="velocity">
        <param name="min">-50.0</param>
        <param name="max">50.0</param>
      </command_interface>
      <state_interface name="position"/>
      <state_interface name="velocity"/>
    </joint>

    <!-- Front steering: position command interface -->
    <joint name="front_left_steering_joint">
      <command_interface name="position">
        <param name="min">-0.5236</param>  <!-- -30 degrees -->
        <param name="max">0.5236</param>   <!-- +30 degrees -->
      </command_interface>
      <state_interface name="position"/>
      <state_interface name="velocity"/>
    </joint>

    <joint name="front_right_steering_joint">
      <command_interface name="position">
        <param name="min">-0.5236</param>
        <param name="max">0.5236</param>
      </command_interface>
      <state_interface name="position"/>
      <state_interface name="velocity"/>
    </joint>
  </ros2_control>

</robot>
